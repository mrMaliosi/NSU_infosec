# Документация: Caesar, CLEFIA‑128 (CBC/PKCS#7) и DM‑хеш

Проект реализует три компонента: потоковый шифр Цезаря для строк, блочный шифр CLEFIA‑128 для файлов в режиме CBC с PKCS#7, и хеш‑функцию по конструкции Davies–Meyer на основе блочного шифра CLEFIA. 

## Обзор алгоритмов

- Caesar cipher: классическая моноалфавитная замена со сдвигом по модулю 26, где \(E_n(x)=(x+n)\bmod 26\) и \(D_n(x)=(x-n)\bmod 26\) над алфавитом A..Z, применимая посимвольно к строкам с сохранением регистра.  
- CLEFIA: 128‑битный блочный шифр от Sony с длинами ключа 128/192/256, использующий четырехветвевую генерализованную сеть Фейстеля GFN4,r, с двумя F‑функциями (F0/F1), S‑боксами S0/S1 и линейной диффузией над GF(2^8), стандартизован в RFC 6114 и принят в ряде стандартов как лёгковесный примитив.  
- Davies–Meyer (DM) хеш: итеративная конструкция из блочного шифра с компрессионной функцией \(H_i = E_{m_i}(H_{i-1}) \oplus H_{i-1}\), где блок сообщения выступает ключом, а предыдущее состояние — входом шифрования, что при использовании CLEFIA‑128 даёт 128‑битный дайджест .  
- Лавинный эффект: изменение одного входного бита должно менять примерно половину выходных бит, что оценивается как ≈50% изменённых бит дайджеста на серии испытаний и служит индикатором хорошей диффузии.  

## Структура проекта

- include/crypto: публичные заголовки caesar.hpp, clefia.hpp, hash.hpp, определяющие стабильный API без зависимости от исполняемых частей.  
- src: реализации caesar.cpp, clefia.cpp, hash.cpp, где для CLEFIA реализованы S0/S1, F0/F1, диффузионные преобразования над GF(2^8), расписание ключей и операция Σ (DoubleSwap).  
- tests: test_crypto.cpp, включающий юнит‑тесты для шифра Цезаря, тест‑вектор CLEFIA‑128 по RFC 6114 (Appendix A), раундтрип CBC/PKCS#7 и проверку лавинного эффекта для DM‑хеша.  

## API

- Caesar  
  - caesar_encrypt(const std::string&, int): шифрует строку с целочисленным сдвигом \(n\) по модулю 26, не изменяя небуквенные символы.  
  - caesar_decrypt(const std::string&, int): обратное преобразование, эквивалентно шифрованию со сдвигом \(-n\).  
- CLEFIA‑128  
  - Clefia128::setKey(Key16): инициализация 128‑битным ключом для профиля с 18 раундами и отбеливанием.  
  - encryptBlock/decryptBlock(Block16): блочное шифрование/расшифрование 16‑байтового блока с начальным и завершающим отбеливанием согласно спецификации.  
  - cbc_encrypt_file/cbc_decrypt_file: файловые утилиты режима CBC поверх блочного шифра с PKCS#7 паддингом и IV длиной 16 байт.  
- Хеш (DM)  
  - clefia128_dm_hash(std::vector<uint8_t>): итерация DM с CLEFIA‑128 как PRP и простым завершением, результат — 16‑байтовый дайджест.  

## Детали реализации CLEFIA‑128

- Сеть и раунды: используется GFN4,r с четырьмя 32‑битными ветвями, F0 и F1 применяются попеременно к двум ветвям за раунд, профиль с ключом 128 бит использует 18 раундов и начальное/конечное отбеливание.  
- Нелинейность и диффузия: байты проходят S‑боксы S0/S1, затем линейное преобразование M0/M1 через умножения в GF(2^8) с неприводимым полиномом \(z^8+z^4+z^3+z^2+1\) (0x11D), формируя 32‑битные выходы F0/F1.  
- Ключевое расписание: вычисляет WK и 36 слов RK из 128‑битного ключа через вспомогательный вектор L, GFN4,12 над набором констант CON_128 и операцию Σ (DoubleSwap), что задаёт нужную энтропию и связность раундовых ключей.  
- Операция Σ (DoubleSwap): побитовая перестановка 128‑битного L по формуле Y = X[7–63] | X[121–127] | X[0–6] | X[64–120], реализованная через склейки и сдвиги между четырьмя 32‑битными big‑endian словами.  

## Режим CBC и паддинг PKCS#7

- CBC: для блоков \(P_i\) и IV длиной 16 байт вычисляется \(C_0=IV\), \(C_i=E_K(P_i\oplus C_{i-1})\), что требует уникального, неповторяющегося IV для каждого шифрования с данным ключом.  
- PKCS#7: дополняет последний блок байтами значения \(N\) (число добавленных байтов), при кратности длины блоку добавляется целый блок из байтов со значением размера блока, что важно корректно проверять при снятии паддинга.  

## Тестирование и валидация

- Блочный тест‑вектор (RFC 6114, Appendix A): K = ffeeddccbbaa99887766554433221100, P = 000102030405060708090a0b0c0d0e0f, ожидаемый C = de2bf2fd9b74aacdf1298555459494fd, что подтверждает корректность примитива и ключевого расписания.  
- CBC‑раундтрип: шифрование и расшифрование псевдослучайных данных с фиксированными ключом и IV возвращает исходные байты при корректной реализации режима и паддинга.  
- Лавинный эффект хеша: при флипе одного бита входа средняя доля изменённых бит дайджеста должна быть около 0.5 на серии испытаний, что проверяется статистически в тестах.  

## Использование и рекомендации

- Caesar: предназначен только для учебных целей, не обеспечивает криптостойкость и уязвим к частотному анализу, поэтому не применим для защиты данных.  
- CLEFIA‑128 (CBC): используйте криптографически случайный IV на каждый запуск и храните/передавайте его вместе с шифртекстом, принимая меры против padding‑oracle при обработке ошибок.  
- DM‑хеш: демонстрационная конструкция с длиной дайджеста 128 бит, подходит для учебной демонстрации свойств диффузии, но не заменяет современные хеш‑стандарты в продуктивных системах.  
